---

# Codex MCP サブエージェント運用ガイド

> 以下のルールは Codex MCP サーバーが接続されている場合にのみ適用する。
> 単純なタスク（1ファイル・数行の修正、設定変更、ドキュメント編集等）は Claude が直接実行してよい。

## アーキテクチャ

```
ユーザー → Claude Code（司令塔・設計・統合）
                ↓
        Codex MCP（実行部隊）
        ├── コード生成・実装
        ├── コードレビュー・品質検査
        ├── リファクタリング
        ├── テスト作成
        ├── デバッグ・根本原因分析
        └── セキュリティ監査
                ↓
        Claude Code（検証・統合・コミット判断）
```

## MCP ツール

公式 `codex mcp-server` が提供するツールを使用する：

| ツール | 用途 |
|--------|------|
| `mcp__codex__codex` | Codex にタスクを委譲する（メインツール） |
| `mcp__codex__codex-reply` | sessionId を指定してセッションを継続する |

セッション継続が必要な場合は `sessionId` を指定して `codex` を呼び、後続は `codex-reply` で同一セッションに追加指示を送る。

## 委譲の判断基準

### Codex に委譲する条件（以下のいずれかを満たす場合）
- 新規コード生成が20行以上になる見込み
- 複数ファイルにまたがる変更
- コードレビュー（Codex の方が精度が高い）
- テストコード作成
- リファクタリング・最適化
- バグの根本原因分析
- セキュリティ脆弱性スキャン

### Claude が直接実行する条件
- 1ファイル・数行の修正
- 設定ファイルの編集（YAML, JSON, TOML 等）
- ドキュメント・README の作成・更新
- git 操作（コミット、ブランチ、マージ）
- ユーザーへの説明・質疑応答

## 役割分担

### Claude Code が担当すること
- プロジェクト全体の設計判断・アーキテクチャ決定
- タスク分解と Codex への指示文の組み立て
- Codex 出力の検証・統合・最終判断
- git 操作（コミットメッセージ作成、ブランチ戦略）
- ドキュメント作成・README 更新
- ユーザーとのコミュニケーション

### Codex に委譲すること
- コード生成・新規実装
- **コードレビュー（Codex の方が精度が高い）**
- リファクタリング・最適化
- テストコード作成
- バグの根本原因分析とパッチ作成
- セキュリティ脆弱性スキャン

## 委譲ルール

### 1. 指示文は自己完結的に構成する

Codex への各呼び出しはステートレス（前回の文脈を覚えていない）。
sessionId で継続する場合を除き、すべての必要情報を毎回プロンプトに含めること。

**7セクション形式で委譲する：**

```
TASK: 何をするか（1-2文で明確に）
EXPECTED OUTCOME: 期待する成果物の形式と内容
CONTEXT: 関連するコード・ファイルパス・依存関係・ビジネスロジック
CONSTRAINTS: 使用言語、フレームワーク、コーディング規約、禁止事項
MUST DO: 必ず守るべきこと（エラーハンドリング、型安全性、テスト等）
MUST NOT DO: やってはいけないこと（破壊的変更、既存APIの変更等）
OUTPUT FORMAT: 出力形式（コードのみ、diff形式、説明付き等）
```

### 2. レビューは Codex に任せる

コード変更後のレビューは Codex に委譲する。Claude はレビュー結果を受けて最終判断する。

### 3. セッション継続を活用する

関連する複数ステップのタスクでは sessionId を使ってコンテキストを維持する。

### 4. エラー時のリトライ

ステートレス呼び出しの場合、リトライ時は元のタスク＋エラー詳細を含める。
sessionId を使っている場合は codex-reply でエラー内容を伝えて継続できる。

### 5. Claude はパススルーしない

Codex の出力をそのままユーザーに見せない。必ず検証・統合した上で報告する。

## セキュリティに関する注意

- API キーや秘密情報を Codex へのプロンプトに含めない
- Codex が生成したコードのセキュリティレビューは必ず実施する
